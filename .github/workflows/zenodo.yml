name: Zenodo

on:
  release:
    types: [published]

jobs:
  zenodo:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Upload to Zenodo
        env:
          ZENODO_TOKEN: ${{ secrets.ZENODO_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          TAG="${GITHUB_REF#refs/tags/}"
          REPO="${GITHUB_REPOSITORY}"
          VERSION="${TAG#v}"

          echo "Publishing ${REPO} ${TAG} to Zenodo..."

          # Check if we have an existing concept (stored as repo secret ZENODO_DEPOSIT_ID)
          DEPOSIT_ID="${{ secrets.ZENODO_DEPOSIT_ID }}"

          if [ -n "$DEPOSIT_ID" ]; then
            echo "Creating new version from existing deposit ${DEPOSIT_ID}..."
            # Create a new version of the existing deposit
            RESPONSE=$(curl -s -X POST \
              "https://zenodo.org/api/deposit/depositions/${DEPOSIT_ID}/actions/newversion" \
              -H "Authorization: Bearer ${ZENODO_TOKEN}")

            NEW_URL=$(echo "$RESPONSE" | python3 -c "import sys,json; print(json.load(sys.stdin)['links']['latest_draft'])")
            NEW_ID=$(echo "$NEW_URL" | grep -o '[0-9]*$')
            echo "New version draft ID: ${NEW_ID}"
          else
            echo "Creating first deposit..."
            # Create a brand new deposit
            RESPONSE=$(curl -s -X POST \
              "https://zenodo.org/api/deposit/depositions" \
              -H "Authorization: Bearer ${ZENODO_TOKEN}" \
              -H "Content-Type: application/json" \
              -d '{}')

            NEW_ID=$(echo "$RESPONSE" | python3 -c "import sys,json; print(json.load(sys.stdin)['id'])")
            echo "New deposit ID: ${NEW_ID}"
          fi

          # Download the release source archive from GitHub
          ARCHIVE_URL="https://github.com/${REPO}/archive/refs/tags/${TAG}.tar.gz"
          curl -sL -o "sppt-${VERSION}.tar.gz" "$ARCHIVE_URL"

          # Delete any existing files in the draft (for new versions)
          EXISTING=$(curl -s \
            "https://zenodo.org/api/deposit/depositions/${NEW_ID}/files" \
            -H "Authorization: Bearer ${ZENODO_TOKEN}")
          for FILE_ID in $(echo "$EXISTING" | python3 -c "import sys,json; [print(f['id']) for f in json.load(sys.stdin)]" 2>/dev/null || true); do
            curl -s -X DELETE \
              "https://zenodo.org/api/deposit/depositions/${NEW_ID}/files/${FILE_ID}" \
              -H "Authorization: Bearer ${ZENODO_TOKEN}"
          done

          # Upload the new archive
          echo "Uploading sppt-${VERSION}.tar.gz..."
          curl -s -X POST \
            "https://zenodo.org/api/deposit/depositions/${NEW_ID}/files" \
            -H "Authorization: Bearer ${ZENODO_TOKEN}" \
            -F "file=@sppt-${VERSION}.tar.gz" \
            -F "name=sppt-${VERSION}.tar.gz"

          # Read metadata from .zenodo.json
          METADATA=$(python3 -c "
          import json
          with open('.zenodo.json') as f:
              z = json.load(f)
          z['version'] = '${VERSION}'
          z['publication_date'] = '$(date +%Y-%m-%d)'
          meta = {'metadata': z}
          print(json.dumps(meta))
          ")

          # Update deposit metadata
          echo "Updating metadata..."
          curl -s -X PUT \
            "https://zenodo.org/api/deposit/depositions/${NEW_ID}" \
            -H "Authorization: Bearer ${ZENODO_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "$METADATA"

          # Publish
          echo "Publishing..."
          PUBLISH_RESPONSE=$(curl -s -X POST \
            "https://zenodo.org/api/deposit/depositions/${NEW_ID}/actions/publish" \
            -H "Authorization: Bearer ${ZENODO_TOKEN}")

          DOI=$(echo "$PUBLISH_RESPONSE" | python3 -c "import sys,json; print(json.load(sys.stdin)['doi'])")
          echo "Published! DOI: ${DOI}"
          echo "URL: https://doi.org/${DOI}"
